---
title: " Crime Forecasts with Prophet"
format:
  html:
    toc: true
    theme: zephyr
---

### üìò Introduction

This page presents crime forecasting results for **Los Angeles**, **San Diego**, and **San Francisco** using the **Prophet time-series model**.
Forecasts are generated from pre-computed Prophet outputs (CSV files), allowing us to visualize trends quickly without retraining the model.

The following visualizations include:

- **30-day forecast comparison** across the three cities
- **Actual vs. predicted crime counts**
- **Forecast confidence intervals**
- **Seasonal components** (weekly, yearly, and daily)

Before examining the forecast results, we first review the **historical daily crime trends**, which provide essential context for understanding the model‚Äôs predictions.



### üîπ Section 1 ‚Äî Daily Crime Baseline (Before Forecasting)

![Daily Crime Baseline](assets/baseline_daily_counts.png)

This chart shows the historical daily crime counts for Los Angeles, San Diego, and San Francisco.
These baseline trends reveal long-term patterns, short-term fluctuations, and seasonality‚Äîall of which inform the Prophet model‚Äôs forecasts.


### üîπ Section 2 ‚Äî Prophet Modeling: Data Preparation

```{python}
print("Before fitting the forecasting models,\nwe convert the daily crime data into the ds‚Äìy format required by Prophet.")

# ============================================================
# Build correct DAILY crime counts for LA, SD, SF
# ============================================================
import pandas as pd

# ===== 1. Load raw CSVs =====
df_la_raw = pd.read_csv("data/los_angeles.csv")
df_sd_raw = pd.read_csv("data/san_diego.csv")
df_sf_raw = pd.read_csv("data/san_francisco.csv", low_memory=False)


# ===== 2. Convert to datetime =====
df_la_raw["incident_date"] = pd.to_datetime(df_la_raw["incident_date"], errors="coerce")
df_sd_raw["incident_date"] = pd.to_datetime(df_sd_raw["incident_date"], errors="coerce")
df_sf_raw["incident_date"] = pd.to_datetime(df_sf_raw["incident_date"], errors="coerce")

# ===== 3. Drop invalid dates =====
df_la_raw = df_la_raw.dropna(subset=["incident_date"])
df_sd_raw = df_sd_raw.dropna(subset=["incident_date"])
df_sf_raw = df_sf_raw.dropna(subset=["incident_date"])

# ===== 4. Extract PURE DATE (remove hours/min/sec) =====
df_la_raw["date"] = df_la_raw["incident_date"].dt.date
df_sd_raw["date"] = df_sd_raw["incident_date"].dt.date
df_sf_raw["date"] = df_sf_raw["incident_date"].dt.date


# ===== 5. Group by daily counts =====

daily_la = (
    df_la_raw.groupby("date")
    .size()
    .reset_index(name="y")
    .rename(columns={"date": "ds"})
)


daily_sd = (
    df_sd_raw.groupby("date")
    .size()
    .reset_index(name="y")
    .rename(columns={"date": "ds"})
)


daily_sf = (
    df_sf_raw.groupby("date")
    .size()
    .reset_index(name="y")
    .reset_index()
    .rename(columns={"date": "ds"})
)

# (Fix SF: previous code mis-grouped, correct version below)

daily_sf = (
    df_sf_raw.groupby("date")
    .size()
    .reset_index(name="y")
    .rename(columns={"date": "ds"})
)

```


### üîπ Section 3 ‚Äî Model Training

```{python}
# ===========================================
# Prophet Model Training (All Cities)
# ===========================================

from prophet import Prophet

# Same parameters for consistency
def train_prophet_model(df):
    model = Prophet(
        daily_seasonality=True,
        weekly_seasonality=True,
        yearly_seasonality=True,
        interval_width=0.90
    )
    model.fit(df)
    return model

m_la = train_prophet_model(daily_la)
m_sd = train_prophet_model(daily_sd)
m_sf = train_prophet_model(daily_sf)
print("‚úì Prophet models trained successfully.")
```

### üîπ Section 4 ‚Äî Forecast Results
```{python}
# ============================================================
# Forecast Results ‚Äî  Los Angeles
# ============================================================
print("----- Los Angeles Forecast Result------")
future_la = m_la.make_future_dataframe(periods=30)
forecast_la = m_la.predict(future_la)
display(forecast_la[["ds", "yhat", "yhat_lower", "yhat_upper"]].tail())

# ============================================================
# Forecast Results ‚Äî  San Francisco
# ============================================================
print("----- San Francisco Forecast Result------")
future_sf = m_sf.make_future_dataframe(periods=30)
forecast_sf = m_sf.predict(future_sf)
display(forecast_sf[["ds", "yhat", "yhat_lower", "yhat_upper"]].tail())

# ============================================================
# Forecast Results ‚Äî San Diego
# ============================================================
print("----- San Diego Forecast Result------")
future_sd = m_sd.make_future_dataframe(periods=30)
forecast_sd = m_sd.predict(future_sd)
display(forecast_sd[["ds", "yhat", "yhat_lower", "yhat_upper"]].tail())
```


```{python}
# ============================================================
# Save Forecast Results as CSV for All 3 Cities
# ============================================================
# Only keep the useful columns
cols = ["ds", "yhat", "yhat_lower", "yhat_upper"]

# LA
forecast_la_out = forecast_la[cols]
forecast_la_out.to_csv("data/los_angeles_forecast.csv", index=False)

# SD
forecast_sd_out = forecast_sd[cols]
forecast_sd_out.to_csv("data/san_diego_forecast.csv", index=False)

# SF
forecast_sf_out = forecast_sf[cols]
forecast_sf_out.to_csv("data/san_francisco_forecast.csv", index=False)
# forecast_la_out.tail() # don't show on website

```

### üîπ Section 5 ‚Äî Forecast Visualization & Comparison

### 1Ô∏è‚É£ 30-Day Crime Forecast Comparison

```{python}
# ============================================================
# Forecast Comparison ‚Äî LA vs SD vs SF
# ============================================================

import matplotlib.pyplot as plt

plt.figure(figsize=(18, 7))
plt.plot(forecast_la["ds"], forecast_la["yhat"], label="Los Angeles", linewidth=2)
plt.plot(forecast_sd["ds"], forecast_sd["yhat"], label="San Diego", linewidth=2)
plt.plot(forecast_sf["ds"], forecast_sf["yhat"], label="San Francisco", linewidth=2)
plt.title("30-Day Crime Forecast Comparison ‚Äî LA vs SD vs SF", fontsize=20)
plt.xlabel("Date")
plt.ylabel("Predicted Daily Crime Count")
plt.legend(fontsize=12)
plt.tight_layout()
plt.show()

```

The 30-day crime forecast illustrates clear differences in projected crime levels across the three cities.

- Los Angeles begins with the highest predicted daily crime counts but shows a sharp downward decline approaching 2025.

- San Diego remains relatively stable with moderate oscillation around its long-term mean.

- San Francisco shows lower overall counts and smoother seasonal patterns, maintaining consistent levels over time.

The visible weekly seasonality bands (tight oscillations) reflect Prophet‚Äôs detection of short-term recurring patterns across all cities.

### 2Ô∏è‚É£ Actual vs Forecast CrimeCount

```{python}
# ============================================================
# Actual vs Forecast ‚Äî Los Angeles / San Diego / San Francisco
# ============================================================
import matplotlib.pyplot as plt


def plot_actual_vs_forecast(daily_df, forecast_df, city_name):
    plt.figure(figsize=(16, 6))

    # actual
    plt.plot(
        daily_df["ds"],
        daily_df["y"],
        label=f"{city_name} Actual",
        color="black",
        linewidth=1,
    )

    # forecast
    plt.plot(
        forecast_df["ds"],
        forecast_df["yhat"],
        label=f"{city_name} Forecast",
        color="red",
        linewidth=2,

    )

    plt.title(f"Actual vs Forecast ‚Äî {city_name}", fontsize=18)
    plt.xlabel("Date")
    plt.ylabel("Crime Count")
    plt.legend()
    plt.tight_layout()
    plt.show()

# LA
plot_actual_vs_forecast(daily_la, forecast_la, "Los Angeles")

# SD
plot_actual_vs_forecast(daily_sd, forecast_sd, "San Diego")

# SF
plot_actual_vs_forecast(daily_sf, forecast_sf, "San Francisco")
```

### 3Ô∏è‚É£ Forecast with Confidence Interval (yhat_lower, yhat_upper)

```{python}
# ============================================================
# Forecast with Confidence Interval (yhat_lower, yhat_upper)
# ============================================================
def plot_forecast_interval(forecast_df, city_name):
    plt.figure(figsize=(16, 6))

    # prediction
    plt.plot(
        forecast_df["ds"],
        forecast_df["yhat"],
        label=f"{city_name} Forecast",
        color="blue",
    )
    # confidence interval shading
    plt.fill_between(
        forecast_df["ds"],
        forecast_df["yhat_lower"],
        forecast_df["yhat_upper"],
        alpha=0.3,
        label="Confidence Interval",

    )
    plt.title(f"Forecast with Confidence Interval ‚Äî {city_name}", fontsize=18)
    plt.xlabel("Date")
    plt.ylabel("Predicted Crime Count")
    plt.legend()
    plt.tight_layout()
    plt.show()


# LA
plot_forecast_interval(forecast_la, "Los Angeles")

# SD
plot_forecast_interval(forecast_sd, "San Diego")

# SF
plot_forecast_interval(forecast_sf, "San Francisco")

```

### 4Ô∏è‚É£ Prophet Seasonal Components (Trend / Weekly / Yearly)

```{python}
# ============================================================
# Prophet Seasonal Components (Trend / Weekly / Yearly)
# ============================================================

def plot_prophet_components(model, city_name):
    fig = model.plot_components(model.predict(model.make_future_dataframe(periods=30)))
    fig.set_size_inches(12, 10)

```

#### Los Angeles

```{python}
# LA
plot_prophet_components(m_la, "Los Angeles")
```

#### San Diego

```{python}
# SD
plot_prophet_components(m_sd, "San Diego")
```

#### San Francisco

```{python}
# SF
plot_prophet_components(m_sf, "San Francisco")
```
